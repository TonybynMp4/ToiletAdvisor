services:
    mysql:
        container_name: mysql
        image: mysql:9
        restart: unless-stopped
        ports:
            - "${DATABASE_PORT:-3306}:3306"
        volumes:
            - mysql:/var/lib/mysql
        environment:
            MYSQL_ROOT_PASSWORD: ${DATABASE_PASSWORD}
            MYSQL_DATABASE: ${DATABASE_NAME}
            MYSQL_USER: ${DATABASE_USER}
            MYSQL_PASSWORD: ${DATABASE_PASSWORD}
        networks:
            - toiletadvisor-network
        healthcheck:
            test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
            interval: 10s
            timeout: 5s
            retries: 5

    redis:
        container_name: redis
        image: redis:8-alpine
        restart: unless-stopped
        volumes:
            - redis:/data
        networks:
            - toiletadvisor-network
        healthcheck:
            test: ["CMD", "redis-cli", "ping"]
            interval: 10s
            timeout: 5s
            retries: 5

    api:
        container_name: api
        image: api-dev
        build:
            context: .
            dockerfile: Dockerfile
            target: api-server-dev
        restart: unless-stopped
        depends_on:
            mysql:
                condition: service_healthy
        ports:
            - ${API_PORT:-3000}:${API_PORT:-3000}
        volumes:
            - ./apps/api-server:/app/apps/api-server
            - ./packages:/app/packages
        environment:
            NODE_ENV: ${NODE_ENV:-development}
            PORT: ${API_PORT:-3000}
            DATABASE_URL: ${DATABASE_URL}
            CORS_ORIGIN: ${CORS_ORIGIN:-http://localhost}
            UPLOADTHING_API_KEY: ${UPLOADTHING_API_KEY}
        networks:
            - toiletadvisor-network
        healthcheck:
            test: curl -f http://localhost:${API_PORT:-3000}/health || exit 1
            interval: 30s
            timeout: 5s
            retries: 5

    auth:
        container_name: auth
        image: auth-dev
        build:
            context: .
            dockerfile: Dockerfile
            target: auth-server-dev
        restart: unless-stopped
        depends_on:
            mysql:
                condition: service_healthy
            redis:
                condition: service_healthy
        ports:
            - ${AUTH_PORT:-3001}:${AUTH_PORT:-3001}
        volumes:
            - ./apps/auth-server:/app/apps/auth-server
            - ./packages:/app/packages
        environment:
            NODE_ENV: ${NODE_ENV:-development}
            PORT: ${AUTH_PORT:-3001}
            DATABASE_URL: ${DATABASE_URL}
            REDIS_URL: redis://redis:6379
            CORS_ORIGIN: ${CORS_ORIGIN:-http://localhost:5173}
        networks:
            - toiletadvisor-network
        healthcheck:
            test: curl -f http://localhost:${AUTH_PORT:-3001}/health || exit 1
            interval: 30s
            timeout: 5s
            retries: 5

    web:
        container_name: web
        image: web-dev
        build:
            context: .
            dockerfile: Dockerfile
            target: web-dev
        restart: unless-stopped
        depends_on:
            api:
                condition: service_healthy
            auth:
                condition: service_healthy
        ports:
            - 5173:5173
        volumes:
            - ./apps/web:/app/apps/web
            - ./packages:/app/packages
        environment:
            VITE_API_URL: ${VITE_API_URL:-http://localhost:3000}
            VITE_AUTH_URL: ${VITE_AUTH_URL:-http://localhost:3001}
        networks:
            - toiletadvisor-network

volumes:
    mysql:
    redis:

networks:
    toiletadvisor-network:
        driver: bridge
